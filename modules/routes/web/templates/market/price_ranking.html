{% extends '/components/_base.html' %}
{% block title %}Price History{% endblock %}
{% block content %}

  <div class="container mt-5">
    <h2>Item Rankings</h2>
    <p class="text-muted">Based on archived data.</p>

    <!-- Date range selectors -->
    <div class="row mb-4">
      <div class="col-md-3">
        <label for="startDate">Start Date</label>
        <input type="date" class="form-control" id="startDate">
      </div>
      <div class="col-md-3">
        <label for="endDate">End Date</label>
        <input type="date" class="form-control" id="endDate">
      </div>
      <div class="col-md-3 align-self-end">
        <button id="applyFilter" class="btn btn-primary">Apply</button>
        <button id="resetFilter" class="btn btn-secondary">Reset</button>
      </div>
    </div>

    <table class="table table-striped" id="rankingTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Item Name</th>
          <th>Avg Price</th>
          <th>Lowest</th>
          <th>Highest</th>
          <th>Mid 80% Avg</th>
          <th>Unid Mid 80% Avg</th>
          <th>Total Items</th>
          <th>Total Unid Items</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Chart.js and date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script>
    function capitalizeWords(str) {
      const smallWords = ['of'];
      return str.split(' ').map((word, index) => {
        if (index === 0 || !smallWords.includes(word.toLowerCase())) {
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }
        return word.toLowerCase();
      }).join(' ');
    }

    function convertEmeraldsToGameFormat(emeralds) {
      let remaining = Math.floor(emeralds);
      const stx = Math.floor(remaining / (64 * 64 * 64));
      remaining %= 64 * 64 * 64;
      const le = Math.floor(remaining / (64 * 64));
      remaining %= 64 * 64;
      const eb = Math.floor(remaining / 64);
      const e = remaining % 64;

      let result = '';
      if (stx > 0) {
        let decimalValue = le + eb / 64 + e / (64 * 64);
        decimalValue = Math.round(decimalValue * 100) / 100;
        const displayLE = Number.isInteger(decimalValue) ?
          decimalValue.toString() : decimalValue.toFixed(2);
        result = `${stx}stx${displayLE !== '0' ? ` ${displayLE}le` : ''}`;
      } else {
        if (le > 0) result += `${le}le `;
        if (eb > 0) result += `${eb}eb `;
        if (e > 0) result += `${e.toFixed(2)}e`;
      }
      return result.trim() || '0e';
    }

    async function fetchRankingData(startDate, endDate) {
      try {
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        const url = '/api/trademarket/ranking' + (params.toString() ? `?${params}` : '');
        const res = await fetch(url);
        const data = await res.json();
        if (res.ok) displayRanking(data);
        else console.error('Failed to load ranking:', data);
      } catch (err) {
        console.error('Error fetching ranking data:', err);
      }
    }

    function displayRanking(items) {
      const tbody = document.querySelector('#rankingTable tbody');
      tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        [
          item.rank,
          capitalizeWords(item.name),
          convertEmeraldsToGameFormat(item.average_price),
          convertEmeraldsToGameFormat(item.lowest_price),
          convertEmeraldsToGameFormat(item.highest_price),
          convertEmeraldsToGameFormat(item.average_mid_80_percent_price),
          convertEmeraldsToGameFormat(item.unidentified_average_mid_80_percent_price),
          item.total_count,
          item.unidentified_count
        ].forEach(text => {
          const td = document.createElement('td'); td.textContent = text;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    window.onload = () => {
      const startInput = document.getElementById('startDate');
      const endInput   = document.getElementById('endDate');
      const applyBtn   = document.getElementById('applyFilter');
      const resetBtn   = document.getElementById('resetFilter');

      applyBtn.addEventListener('click', () => {
        fetchRankingData(startInput.value, endInput.value);
      });
      resetBtn.addEventListener('click', () => {
        startInput.value = '';
        endInput.value = '';
        fetchRankingData();
      });

      // Initial load
      fetchRankingData();
    };
  </script>
{% endblock %}
